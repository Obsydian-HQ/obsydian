# Publishing Obsydian to Bazel Central Registry (BCR)

This guide documents how to publish the Obsydian framework to the Bazel Central Registry
so users can simply use `bazel_dep(name = "obsidian", version = "X.Y.Z")` without any overrides.

## Overview

There are two parts:
1. **Initial submission** - Get Obsydian into BCR (one-time, requires PR review)
2. **Automated releases** - Set up GitHub Actions to auto-publish new versions

---

## Part 1: Initial BCR Submission

### Prerequisites

- [ ] Ensure MODULE.bazel is properly configured at repo root
- [ ] Create a GitHub release with a tag (e.g., `v0.1.0`)
- [ ] Fork https://github.com/bazelbuild/bazel-central-registry

### Step 1: Create BCR Template Files

Create `.bcr/` directory in your obsydian repo with these files:

#### `.bcr/metadata.template.json`
```json
{
    "homepage": "https://github.com/Obsydian-HQ/obsydian",
    "maintainers": [
        {
            "email": "your-email@example.com",
            "github": "your-github-username",
            "name": "Your Name"
        }
    ],
    "repository": [
        "github:Obsydian-HQ/obsydian"
    ],
    "versions": [],
    "yanked_versions": {}
}
```

#### `.bcr/source.template.json`
```json
{
    "integrity": "",
    "strip_prefix": "{REPO}-{VERSION}",
    "url": "https://github.com/{OWNER}/{REPO}/releases/download/{TAG}/obsidian-{VERSION}.tar.gz"
}
```

#### `.bcr/presubmit.yml`
```yaml
bcr_test_module:
  module_path: "examples/hello_world"
  matrix:
    platform:
      - macos
    bazel:
      - 7.x
      - 8.x
  tasks:
    run_tests:
      name: "Build hello world example"
      platform: ${{ platform }}
      bazel: ${{ bazel }}
      build_targets:
        - "@obsidian//examples/hello_world:hello_world_app"
```

### Step 2: Run BCR Add Module Tool

```bash
# Clone your fork of BCR
git clone https://github.com/YOUR_USERNAME/bazel-central-registry.git
cd bazel-central-registry

# Run the interactive tool
bazel run //tools:add_module

# It will prompt for:
# - Module name: obsidian
# - Module version: 0.1.0
# - Compatibility level: 0
# - Source archive URL: https://github.com/Obsydian-HQ/obsydian/archive/refs/tags/v0.1.0.tar.gz
# - Strip prefix: obsydian-0.1.0
# - MODULE.bazel contents (or path)
# - Build targets to expose: @obsidian//src:obsidian_impl
```

### Step 3: Validate Your Module

```bash
# In BCR repo
bazel run -- //tools:bcr_validation --check=obsidian@0.1.0
```

### Step 4: Submit Pull Request

```bash
git checkout -b add-obsidian-0.1.0
git add modules/obsidian
git commit -m "Add obsidian 0.1.0"
git push origin add-obsidian-0.1.0
# Then create PR on GitHub
```

### Step 5: Wait for Review

BCR maintainers will review your PR. This typically takes 1-5 days.
Once approved and merged, users can immediately use:

```python
bazel_dep(name = "obsidian", version = "0.1.0")
```

---

## Part 2: Automated Publishing (After Initial Approval)

Once your module is in BCR, automate future releases:

### Step 1: Fork BCR (if not already done)

Fork https://github.com/bazelbuild/bazel-central-registry to Obsydian-HQ org.

### Step 2: Create Personal Access Token

1. Go to https://github.com/settings/tokens
2. Create a "Classic" token with `repo` and `workflow` permissions
3. Save it as `BCR_PUBLISH_TOKEN` secret in Obsydian-HQ/obsydian repo

### Step 3: Create Release Workflow

Create `.github/workflows/release.yml`:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true

  publish-bcr:
    needs: release
    uses: bazel-contrib/publish-to-bcr/.github/workflows/publish.yaml@v0.2.0
    with:
      tag_name: ${{ github.ref_name }}
      registry_fork: Obsydian-HQ/bazel-central-registry
      attest: false  # Set true if using release_ruleset workflow
    permissions:
      contents: write
    secrets:
      publish_token: ${{ secrets.BCR_PUBLISH_TOKEN }}
```

### Step 4: Test It

```bash
# Create and push a new tag
git tag v0.2.0
git push origin v0.2.0
```

The workflow will automatically:
1. Create a GitHub release
2. Generate BCR entry files
3. Open a PR to bazelbuild/bazel-central-registry
4. BCR maintainers merge (usually same-day for existing modules)

---

## Current Status (Before BCR)

Until BCR submission is complete, users use `git_override`:

```python
bazel_dep(name = "obsidian", version = "0.1.0")
git_override(
    module_name = "obsidian",
    remote = "https://github.com/Obsydian-HQ/obsydian.git",
    tag = "v0.1.0",
)
```

---

## Files Generated by BCR

After submission, BCR will contain:

```
modules/
  obsidian/
    metadata.json           # Module metadata, maintainers, versions
    0.1.0/
      MODULE.bazel          # Copy of your MODULE.bazel
      source.json           # Where to download source
      presubmit.yml         # CI tests
      patches/              # Any patches (optional)
```

---

## Resources

- [BCR Documentation](https://github.com/bazelbuild/bazel-central-registry/blob/main/docs/README.md)
- [BCR Policies](https://github.com/bazelbuild/bazel-central-registry/blob/main/docs/bcr-policies.md)
- [publish-to-bcr GitHub Action](https://github.com/bazel-contrib/publish-to-bcr)
- [Bzlmod User Guide](https://bazel.build/docs/bzlmod)
